app-id: net.pcsx2.PCSX2
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '6.4'
command: pcsx2-qt
finish-args:
  - --device=all
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --filesystem=host:ro
  - --talk-name=org.freedesktop.ScreenSaver
modules:
  - name: libaio
    no-autogen: true
    make-install-args:
      - prefix=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://pagure.io/libaio.git
        tag: libaio-0.3.113
        commit: 1b18bfafc6a2f7b9fa2c6be77a95afed8b7be448
        x-checker-data:
          type: git
          tag-pattern: ^libaio-([\d.]+)$
    cleanup:
      - /include
      - /lib/*.a
  - name: soundtouch
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://codeberg.org/soundtouch/soundtouch.git
        tag: 2.3.2
        commit: 29fba832a7920a04eab956b3990c50e13d8c93f9
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/pkgconfig
      - /share/doc
      - /lib/*.a
  - name: png++
    disabled: true
    buildsystem: autotools
    make-install-args:
      - prefix=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://download.savannah.nongnu.org/releases/pngpp/png++-0.2.10.tar.gz
        sha256: 998af216ab16ebb88543fbaa2dbb9175855e944775b66f2996fc945c8444eee1
  - name: libpcap
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/the-tcpdump-group/libpcap.git
        tag: libpcap-1.10.4
        commit: 104271ba4a14de6743e43bcf87536786d8fddea4
        x-checker-data:
          type: git
          tag-pattern: ^libpcap-([\d.]+)$
    cleanup:
      - /bin
      - /include
      - /share/man
      - /lib/pkgconfig
      - /lib/*.a
  - name: clang
    buildsystem: simple
    build-commands:
      - true
    post-install:
      - mkdir -p "${FLATPAK_DEST}"/clang
      - tar xf * --strip-components=1 -C "${FLATPAK_DEST}"/clang
      - chmod -R +w "${FLATPAK_DEST}"/clang
      - bash -c 'export test=success && cat > "${FLATPAK_DEST}"/clang/clang-toolchain.cmake << EOF

        set(CMAKE_C_COMPILER "${FLATPAK_DEST}/clang/bin/clang")

        set(CMAKE_CXX_COMPILER "${FLATPAK_DEST}/clang/bin/clang++")

        set(CMAKE_EXE_LINKER_FLAGS_INIT "-fuse-ld=${FLATPAK_DEST}/clang/bin/ld.lld")

        set(CMAKE_MODULE_LINKER_FLAGS_INIT "-fuse-ld=${FLATPAK_DEST}/clang/bin/ld.lld")

        set(CMAKE_SHARED_LINKER_FLAGS_INIT "-fuse-ld=${FLATPAK_DEST}/clang/bin/ld.lld")

        EOF'
    sources:
      - type: file
        url: https://github.com/llvm/llvm-project/releases/download/llvmorg-16.0.4/clang+llvm-16.0.4-x86_64-linux-gnu-ubuntu-22.04.tar.xz
        sha256: fd464333bd55b482eb7385f2f4e18248eb43129a3cda4c0920ad9ac3c12bdacf
  - name: pcsx2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DQT_BUILD=ON
      - -DCUBEB_API=ON
      - -DX11_API=ON
      - -DWAYLAND_API=ON
      - -DENABLE_SETCAP=OFF
      - -DUSE_SYSTEM_SDL2=ON
      - -DUSE_SYSTEM_ZSTD=OFF
      - -DDISABLE_ADVANCE_SIMD=TRUE
      - -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON
      - -DCMAKE_TOOLCHAIN_FILE=/app/clang/clang-toolchain.cmake
    cleanup:
      - /share/pixmaps
      - /share/man
      - /share/doc
    post-install:
      - cp -r bin/pcsx2-qt ../bin/* "${FLATPAK_DEST}"/bin
      - rm "${FLATPAK_DEST}"/bin/portable.ini
      - install -Dm644 ../bin/resources/icons/AppIconLarge.png "${FLATPAK_DEST}"/share/icons/hicolor/256x256/apps/net.pcsx2.PCSX2.png
      - install -Dm644 ../net.pcsx2.PCSX2.metainfo.xml "${FLATPAK_DEST}"/share/metainfo/net.pcsx2.PCSX2.metainfo.xml
      - install -Dm644 ../.github/workflows/scripts/linux/pcsx2-qt.desktop "${FLATPAK_DEST}"/share/applications/net.pcsx2.PCSX2.desktop
      - desktop-file-edit --set-key=Icon --set-value=net.pcsx2.PCSX2 "${FLATPAK_DEST}"/share/applications/net.pcsx2.PCSX2.desktop
      - rm -rf "${FLATPAK_DEST}"/clang
    sources:
      - type: git
        url: https://github.com/PCSX2/pcsx2.git
        tag: v1.7.4551
        commit: 9d3de8631cbb36620f952bed0015eea49cd4636a
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: file
        path: net.pcsx2.PCSX2.metainfo.xml
  - name: pcsx2_patches
    buildsystem: simple
    build-commands:
      - cd patches/ && zip -r ../patches.zip *
      - install -Dm644 patches.zip ${FLATPAK_DEST}/bin/resources/patches.zip
    sources:
      - type: git
        url: https://github.com/PCSX2/pcsx2_patches.git
        commit: d87437a20c552d149635c88a57ce8853ca80d55a
        x-checker-data:
          type: git
          tag-pattern: (latest)
